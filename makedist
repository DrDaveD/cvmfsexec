#!/bin/bash
#
# Create the cvmfs dist directory, downloading the latest rpms from
#   the three major sources.
# Written by Dave Dykstra 17 April 2019
#

usage()
{
    (
    echo "Usage: makedist [-s] {osg|egi|default}"
    echo "       makedist [-s] -o <self_extracting_script>"
    echo " The first usage creates a distribution in 'dist' directory."
    echo " The second usage puts 'dist' and cvmfsexec tools into one script with the"
    echo "   given file name that self extracts and executes cvmfsexec."
    echo "   After extraction, files are left behind under '.cvmfsexec' in the same"
    echo "   directory as the script."
    echo " The -s option makes both operations work for singcvmfs instead"
    echo "   of cvmfsexec, and files are left in \$HOME/.singcvmfs"
    ) >&2
    exit 1
}

distroversion() {
    if [ -f /etc/os-release ]; then
        source /etc/os-release
        echo "${VERSION_ID/.*/}"
    elif [ -f /etc/redhat-release ]; then
        read LINE </etc/redhat-release
        case "$LINE" in
            *"release 6"*)
                echo "6"
                ;;
        esac
    fi
}

EL="`distroversion`"
ARCH="`arch`"

HERE="$(cd `dirname $0` && pwd)"

DIST="$HERE/dist"

SING=false
if [ "$1" = -s ]; then
    SING=true
    shift
fi
case $1 in
    -o)

        if [ $# != 2 ]; then
            usage
        fi
        BASENAME=cvmfsexec
        TOOLS="cvmfsexec mountrepo umountrepo"
        SEDOPTS=""
        NEEDLIB=libcvmfs_fuse.so
        REQUIRES=makedist
        if $SING; then
            BASENAME=singcvmfs
            TOOLS="singcvmfs"
            SEDOPTS="-e s/cvmfsexec/$BASENAME/ -e s/^BASEDIR=.*/BASEDIR=\$HOME/"
            NEEDLIB=libcvmfs_fuse3.so
            REQUIRES="makedist -s"
        fi
        if [ ! -f $DIST/usr/lib*/$NEEDLIB ]; then
            echo "Must be run from where cvmfs distribution was made by $REQUIRES" >&2
            exit 1
        fi
        sed -e 's/^[ \t]*//' $SEDOPTS >$2 <<'!EOF!'
        #!/bin/bash
        BASEDIR="$(cd `dirname $0` && pwd)"
        BASE="$BASEDIR/.cvmfsexec"
        if [ $0 -nt $BASE ]; then
            rm -rf $BASE
            mkdir $BASE
            TAR_START="`awk '/^__TAR_BELOW__/ {print NR + 1; exit 0; }' $0`"
            tail -n+$TAR_START $0 | tar -xzf - -C $BASE
        fi
        exec $BASE/cvmfsexec "$@"
        __TAR_BELOW__
!EOF!
        tar --exclude 'dist/var/run/cvmfs/*' --exclude 'dist/var/lib/cvmfs/*' -czvf - -C $HERE $TOOLS dist >>"$2"
        chmod +x "$2"
        exit
        ;;
    osg)
        if [ "$EL" = 6 ]; then
            REL=3.4
        else
            REL=3.5
        fi
        URL="https://repo.opensciencegrid.org/osg/$REL/el$EL/release/$ARCH";;
    egi)
        if [ "$EL" = 6 ]; then
            OS=sl6
        else
            OS=centos$EL
        fi
        URL="http://repository.egi.eu/sw/production/umd/4/$OS/$ARCH/updates";;
    default)
        URL="http://cvmrepo.web.cern.ch/cvmrepo/yum/cvmfs/EL/$EL/$ARCH";;
    *) usage;;
esac

if [ -d $DIST ]; then
    echo "$DIST already exists" >&2
    exit 1
fi

LIST="`curl -Ls $URL/|grep "cvmfs-"|sed 's/.*href="//;s/".*//'`"
PKGS="`echo "$LIST"|grep "^cvmfs-[0-9]"|tail -1`"
if [ -z "$PKGS" ]; then
    echo "No cvmfs package found from $URL" >&2
    exit 1
fi
PKGS="$PKGS `echo "$LIST"|grep "^cvmfs-config-$1-[0-9]"|tail -1`"
PKGS="$PKGS `echo "$LIST"|grep "^cvmfs-x509-helper-[0-9]"|tail -1`"

URLS=""
FUSE3PKGS=""
if [ "$EL" -ge 8 ]; then
    # fuse3 moved from EPEL to the base OS in RHEL 8.1
    RELEASE="`sed 's/.* release //;s/ .*//' /etc/redhat-release`"
    FUSE3URL="http://mirror.centos.org/centos-$EL/$RELEASE/BaseOS/$ARCH/os/Packages/"
else
    FUSE3URL="http://download.fedoraproject.org/pub/epel/$EL/$ARCH/Packages/f/"
fi
if $SING; then
    PKGS="$PKGS `echo "$LIST"|grep "^cvmfs-fuse3-[0-9]"|tail -1`"
    FUSE3PKGS="`curl -Ls $FUSE3URL|grep fuse3-libs-[0-9].*$ARCH|sed 's/.*href="//;s/".*//'`"
    if [ -z "$FUSE3PKGS" ]; then
        echo "No fuse3-libs package found from $FUSE3URL" >&2
        exit 1
    fi
fi

for PKG in $PKGS; do
    URLS="$URLS $URL/$PKG"
done
for PKG in $FUSE3PKGS; do
    URLS="$URLS $FUSE3URL/$PKG"
done

mkdir $DIST
cd $DIST
for U in $URLS; do
    echo "Extracting $U into $DIST"
    curl -Ls "$U"|rpm2cpio -|cpio -idmv -f "*/.build-id*"
done

echo "./etc/cvmfs/default.local"
cat >etc/cvmfs/default.local <<!EOF!
CVMFS_HTTP_PROXY="auto;DIRECT"
CVMFS_PAC_URLS="http://cernvm-wpad.fnal.gov/wpad.dat;http://cernvm-wpad.cern.ch/wpad.dat"
!EOF!
